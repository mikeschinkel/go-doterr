
# `doterr` CLI Product Requirements Document

## Project: `doterr` CLI and Template System

### 1. Overview

**Product name:** `doterr`  
**Purpose:** Provide a lightweight, dependency-free error handling utility for Go projects using a consistent template-based model.  

The `doterr` system consists of:

1. A **single-file Go template** (`doterr.go.tmpl`) containing all helper functions (e.g., `NewErr`, `WrapErr`, etc.).
2. A **CLI tool** (`doterr`) that manages installing and synchronizing this file across packages.
3. An **interactive TUI** for setup and maintenance.
4. **go:generate integration** for easy regeneration in CI or local workflows.

The guiding Go proverb:

> “A little copying is better than a little dependency.”

---

### 2. Goals

- Allow packages to use `doterr` **without a dependency**.
- Provide a **CLI-driven project-level workflow** for maintaining `doterr.go` files and dot-imports.
- Offer an **interactive TUI** for intuitive configuration and updates.
- Ensure **automatic synchronization** with reproducible builds via `go:generate`.
- Keep the **API frozen and stable**, minimizing future churn.

---

### 3. Non-Goals

- No runtime dependency management or package registry.
- No semver drift tracking beyond major versions (`v1`, `v2`, etc.).
- No enforcement of `go.mod`; file discovery is directory-based.
- No network calls beyond fetching the template from the repo if requested.

---

### 4. Design Principles

1. **YAGNI simplicity** — only render and compare, no hashes or metadata.
2. **Lightweight config** — a tiny `doterr.json` at repo root.
3. **Idempotent operations** — rerunning `doterr apply` never produces spurious diffs.
4. **Human-readable headers** — include CLI version, timestamp, and repo link.
5. **Stable, frozen API** — avoid churn; future updates use `v2`, `v3`, etc.

---

### 5. Components

#### 5.1 Template: `doterr.go.tmpl`

A single Go source file rendered per package configured for “copy” mode.

```go
// SPDX-License-Identifier: {{ .SPDX | default "MIT" }}
//
// Code generated by doterr; DO NOT EDIT.
// doterr CLI: {{ .CLIVersion }}{{ if not .Deterministic }}
// Rendered: {{ .RenderedAt }}{{ end }}
// Source: {{ .RepoURL }} (template {{ .TemplateVersion }})
//
// This file provides the tiny, dependency-free doterr helpers for this package.


// Package {{ .PackageName }} provides error-handling helpers
// consistent with the doterr pattern.
package {{ .PackageName }}
````

**Template variables:**

| Variable           | Description                    | Example                                  |
|--------------------|--------------------------------|------------------------------------------|
| `.SPDX`            | SPDX license ID                | `MIT`                                    |
| `.CLIVersion`      | CLI version                    | `v1.2.0`                                 |
| `.RenderedAt`      | RFC3339 timestamp              | `2025-10-17T16:42:31Z`                   |
| `.RepoURL`         | Source repository              | `https://github.com/mikeschinkel/doterr` |
| `.TemplateVersion` | Template major version         | `v1`                                     |
| `.PackageName`     | Go package name                | `foo`                                    |
| `.Deterministic`   | Suppresses timestamp when true | Boolean                                  |

---

#### 5.2 Configuration File: `doterr.json`

Lightweight config file defining template version and per-package modes.

```json
{
  "template": "v1",
  "default": "dot",
  "packages": {
    "./internal/**": "copy",
    "./experimental/**": "ignore"
  }
}
```

**Fields:**

* `template`: Template track (major version only).
* `default`: Default mode (`dot`, `copy`, or `ignore`).
* `packages`: Optional path globs for specific modes.

---

### 6. CLI Commands

#### 6.1 `doterr init [--apply] [--repo <url>] [--spdx <id>] [--template <ver>]`

* Scans all directories with `.go` files (or uses `go list ./...` if available).
* Presents a **TUI interface**:

    * Displays all packages with tri-state toggles: **Dot**, **Copy**, or **Ignore**.
    * Defaults to `dot`.
    * Allows selecting global defaults and editing overrides.
* Writes `doterr.json` to repo root.
* If `--apply` (or confirmed in TUI), runs `doterr apply` immediately.

#### 6.2 `doterr apply [--dry-run] [--auto=<mode>] [--write-config] [--deterministic]`

* Reads `doterr.json` and enforces configuration:

    * **dot** → ensures `import . "github.com/mikeschinkel/doterr/v1"`
    * **copy** → renders `doterr.go` from template
    * **ignore** → skips
* **New packages:**

    * Interactive: prompts in TUI for mode selection and updates config.
    * Non-interactive: fails unless `--auto=<mode>` provided.
* Options:

    * `--dry-run`: Preview changes.
    * `--write-config`: Persist auto decisions.
    * `--deterministic`: Omit timestamp.
* Always formats with `gofmt` and only overwrites when content differs.

#### 6.3 `doterr check`

* Performs the same comparison as `apply --dry-run`.
* Exits non-zero if drift or unclassified packages exist.
* Intended for CI validation.

#### 6.4 (Future) `doterr upgrade --to v2`

* Upgrades template version in `doterr.json`.
* Re-renders `copy` packages with the new template.
* Optional migration support for renamed symbols or changed APIs.

---

### 7. go:generate Integration (Required)

Every copied file includes a `go:generate` directive:

```go
//go:generate doterr apply --deterministic
```

Alternatively, projects may include a central file:

```go
//go:build tools
package tools

//go:generate doterr apply
```

**Rationale:**
Ensures consistent regeneration during `go generate ./...` runs, integrates cleanly with existing Go workflows, and avoids developer forgetfulness.

---

### 8. File Discovery Rules

* Scan all directories containing `.go` files.
* Skip:

    * `vendor/`
    * `testdata/`
    * `.git/`
    * hidden or generated dirs
* Just use direct FS scan, not `go list ./...`.
* No enforcement of modules — workspaces and flat trees both supported.

---

### 9. Generated File Behavior

| Rule          | Description                                                    |
| ------------- | -------------------------------------------------------------- |
| File name     | Always `doterr.go`                                             |
| Format        | Automatically `gofmt`ed                                        |
| Update rule   | Overwrite only if bytes differ                                 |
| Header        | Always begins with `// Code generated by doterr; DO NOT EDIT.` |
| Compile check | Must compile standalone with only stdlib imports               |

---

### 10. Modes

| Mode     | Action               | Typical Use              |
| -------- | -------------------- | ------------------------ |
| `dot`    | Adds dot-import line | App-specific packages    |
| `copy`   | Writes `doterr.go`   | Reusable libraries       |
| `ignore` | Skips                | Experiments, vendor dirs |

---

### 11. Interactive TUI (Required)

**Purpose:** Make configuration and maintenance approachable, even for new developers.

**Features:**

* Clear package list with current mode shown.
* Spacebar toggles mode: dot → copy → ignore → dot.
* Sidebar showing defaults and CLI options.
* Inline help (press `?`).
* `q` or `Ctrl+C` cancels without saving.
* Upon save:

    * Writes updated `doterr.json`.
    * Optionally runs `doterr apply` immediately.

**Implementation:**
Use `charmbracelet/bubbletea` or similar TUI framework for maintainability.

---

### 12. Performance Expectations

* `doterr apply` completes under **2 seconds** on projects ≤1000 packages.
* All operations idempotent.
* No network calls during normal use (unless fetching a remote template).

---

### 13. Error Handling & Edge Cases

| Case                   | Behavior                                            |
| ---------------------- | --------------------------------------------------- |
| Edited copied file     | Overwritten if content differs; warn on `--dry-run` |
| New package            | Prompt in TUI or fail unless `--auto` provided      |
| Invalid template       | Fall back to `v1` with warning                      |
| Missing config         | Suggest running `doterr init`                       |
| Formatting differences | Compare post-`gofmt` output to prevent churn        |

---

### 14. Deterministic Builds

* `--deterministic` omits timestamp.
* Used for reproducible CI environments.
* Example deterministic header:

```go
// Code generated by doterr; DO NOT EDIT.
// doterr CLI: v1.2.0
// Source: https://github.com/mikeschinkel/doterr (template v1)
```

---

### 15. Deliverables

1. **CLI binary:** `doterr` (Go-built)
2. **Template file:** `doterr.go.tmpl`
3. **Documentation:**

    * `README.md`
    * `doterr.json` schema
    * CLI help text
    * Example TUI screenshots
    * Example `go:generate` usage

---

### 16. Future Enhancements (Post-v1)

* `doterr upgrade` command for migrating template versions.
* Template version locking by tag (`v1.0.0` → `v1.1.0`).
* Plugin support for related one-file utilities (`dotlog`, `dotcfg`, etc.).
* `--summary` mode for displaying diff statistics.
* Optional remote template syncing from a Git repo.

---

### 17. Success Criteria

* Running `doterr apply` twice produces no changes.
* All generated files compile cleanly and pass `go vet` / `go fmt`.
* New developers can configure a repo via the TUI without reading docs.
* `go generate ./...` regenerates `doterr.go` files consistently.
* `doterr check` integrates easily into CI.

---

- **Author:** Mike Schinkel
- **Version:** Draft v0.2 (2025-10-17)
- **Status:** In Design Review

```
---
